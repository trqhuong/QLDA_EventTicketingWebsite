{% extends 'organizer_layout/base.html' %}


{% block content %}
<div class="container my-4">
    <h3 class="text-success fw-bold mb-4">üìä Th·ªëng k√™ s·ª± ki·ªán & doanh thu</h3>
    <!-- B·ªô l·ªçc nƒÉm, th√°ng & qu√Ω -->
    <form method="GET" class="d-flex justify-content-center align-items-center mb-4 gap-2">
        <!-- Ch·ªçn nƒÉm -->
        <select name="year" class="form-select filter-select w-auto">
            <option value="">-- Ch·ªçn nƒÉm --</option>
            {% for year in years %}
                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>

        <!-- Ch·ªçn th√°ng -->
        <select name="month" class="form-select filter-select w-auto" id="monthSelect">
            <option value="">-- Ch·ªçn th√°ng --</option>
            {% for i in range(1, 13) %}
                <option value="{{ i }}" {% if i == selected_month %}selected{% endif %}>Th√°ng {{ i }}</option>
            {% endfor %}
        </select>

        <!-- Ch·ªçn qu√Ω -->
        <select name="quarter" class="form-select filter-select w-auto" id="quarterSelect">
            <option value="">-- Ch·ªçn qu√Ω --</option>
            <option value="1" {% if selected_quarter == 1 %}selected{% endif %}>Qu√Ω 1 (Th√°ng 1-3)</option>
            <option value="2" {% if selected_quarter == 2 %}selected{% endif %}>Qu√Ω 2 (Th√°ng 4-6)</option>
            <option value="3" {% if selected_quarter == 3 %}selected{% endif %}>Qu√Ω 3 (Th√°ng 7-9)</option>
            <option value="4" {% if selected_quarter == 4 %}selected{% endif %}>Qu√Ω 4 (Th√°ng 10-12)</option>
        </select>

        <!-- N√∫t l·ªçc -->
        <button type="submit" class="btn btn-success">L·ªçc</button>
        {% if is_admin %}
            <a href="/admin/statsview/" class="btn btn-secondary">Reset</a>
        {% else %}
            <a href="{{ url_for('report_event') }}" class="btn btn-secondary">Reset</a>
        {% endif %}
    </form>

    <!-- Th·ªëng k√™ nhanh -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="stat-card text-center">
                <h5 class="text-secondary">T·ªïng s·ªë s·ª± ki·ªán</h5>
                <p class="stat-number text-success">{{ total_events }}</p>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stat-card text-center">
                <h5 class="text-secondary">T·ªïng doanh thu</h5>
                <p class="stat-number text-success">{{ "{:,.0f}".format(total_revenue) }} VND</p>
            </div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="stat-card">
                <h6 class="mb-3">
                    {% if selected_quarter %}
                        S·ª± ki·ªán theo qu√Ω {{ selected_quarter }}
                    {% elif selected_month %}
                        S·ª± ki·ªán th√°ng {{ selected_month }}
                    {% else %}
                        S·ª± ki·ªán theo th√°ng
                    {% endif %}
                </h6>
                <canvas id="eventsChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stat-card">
                <h6 class="mb-3">
                    {% if selected_quarter %}
                        Doanh thu theo qu√Ω {{ selected_quarter }}
                    {% elif selected_month %}
                        Doanh thu th√°ng {{ selected_month }}
                    {% else %}
                        Doanh thu theo th√°ng
                    {% endif %}
                </h6>
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Chi ti·∫øt th·ªëng k√™ s·ª± ki·ªán -->
    {% if event_statistics %}
    <div class="mt-5">
        <h5 class="text-success fw-bold mb-3">üìã Chi ti·∫øt s·ª± ki·ªán</h5>
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>T√™n s·ª± ki·ªán</th>
                        <th>Ng√†y</th>
                        <th>Gi·ªù</th>
                        <th>V√© ƒë√£ b√°n</th>
                        <th>Doanh thu</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in event_statistics %}
                    <tr>
                        <td>{{ event.name }}</td>
                        <td>{{ event.date.strftime('%d/%m/%Y') }}</td>
                        <td>{{ event.time.strftime('%H:%M') }}</td>
                        <td>{{ event.tickets_sold }}</td>
                        <td>{{ "{:,.0f}".format(event.revenue) }} VND</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // X·ª≠ l√Ω t∆∞∆°ng t√°c gi·ªØa month v√† quarter select
    const monthSelect = document.getElementById('monthSelect');
    const quarterSelect = document.getElementById('quarterSelect');

    monthSelect.addEventListener('change', function() {
        if (this.value) {
            quarterSelect.value = '';
            quarterSelect.disabled = true;
        } else {
            quarterSelect.disabled = false;
        }
    });

    quarterSelect.addEventListener('change', function() {
        if (this.value) {
            monthSelect.value = '';
            monthSelect.disabled = true;
        } else {
            monthSelect.disabled = false;
        }
    });

    // Kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu
    if (monthSelect.value) {
        quarterSelect.disabled = true;
    }
    if (quarterSelect.value) {
        monthSelect.disabled = true;
    }

    // D·ªØ li·ªáu ƒë·ªông t·ª´ backend
    const eventsData = {{ monthly_events | safe }};
    const revenueData = {{ monthly_revenue | safe }};

    // X·ª≠ l√Ω labels v√† d·ªØ li·ªáu d·ª±a tr√™n vi·ªác c√≥ l·ªçc theo th√°ng, qu√Ω hay kh√¥ng
    let chartLabels, chartEventsData, chartRevenueData;

    {% if selected_quarter %}
        // N·∫øu l·ªçc theo qu√Ω, hi·ªÉn th·ªã 3 th√°ng c·ªßa qu√Ω ƒë√≥
        const quarterMonths = {
            1: ["Th√°ng 1", "Th√°ng 2", "Th√°ng 3"],
            2: ["Th√°ng 4", "Th√°ng 5", "Th√°ng 6"],
            3: ["Th√°ng 7", "Th√°ng 8", "Th√°ng 9"],
            4: ["Th√°ng 10", "Th√°ng 11", "Th√°ng 12"]
        };
        chartLabels = quarterMonths[{{ selected_quarter }}];
        chartEventsData = eventsData;
        chartRevenueData = revenueData;
    {% elif selected_month %}
        // N·∫øu l·ªçc theo th√°ng c·ª• th·ªÉ, ch·ªâ hi·ªÉn th·ªã th√°ng ƒë√≥
        chartLabels = ["Th√°ng {{ selected_month }}"];
        chartEventsData = eventsData;
        chartRevenueData = revenueData;
    {% else %}
        // N·∫øu kh√¥ng l·ªçc theo th√°ng ho·∫∑c qu√Ω, hi·ªÉn th·ªã c·∫£ 12 th√°ng
        chartLabels = ["Th√°ng 1", "Th√°ng 2", "Th√°ng 3", "Th√°ng 4", "Th√°ng 5", "Th√°ng 6",
                      "Th√°ng 7", "Th√°ng 8", "Th√°ng 9", "Th√°ng 10", "Th√°ng 11", "Th√°ng 12"];
        chartEventsData = eventsData;
        chartRevenueData = revenueData;
    {% endif %}

    // Chart s·ª± ki·ªán
    new Chart(document.getElementById("eventsChart"), {
      type: "bar",
      data: {
        labels: chartLabels,
        datasets: [{
          label: "S·ªë s·ª± ki·ªán",
          data: chartEventsData,
          backgroundColor: "rgba(25,135,84,0.8)"
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              color: "#fff",
              font: { size: 14, weight: "bold" },
              stepSize: 1
            },
            grid: { color: "rgba(255,255,255,0.1)" }
          },
          x: {
            ticks: {
              color: "#fff",
              font: { size: 14, weight: "bold" }
            },
            grid: { color: "rgba(255,255,255,0.1)" }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: "#fff"
            }
          }
        }
      }
    });

    // Chart doanh thu
    new Chart(document.getElementById("revenueChart"), {
      type: {% if selected_month %}"bar"{% else %}"line"{% endif %},
      data: {
        labels: chartLabels,
        datasets: [{
          label: "Doanh thu (VND)",
          data: chartRevenueData,
          backgroundColor: {% if selected_month or selected_quarter %}"rgba(25,135,84,0.8)"{% else %}"rgba(25,135,84,0.2)"{% endif %},
          borderColor: "rgba(25,135,84,1)",
          borderWidth: 2,
          {% if not selected_month and not selected_quarter %}fill: true{% endif %}
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              color: "#fff",
              font: { size: 14, weight: "bold" },
              callback: function(value) {
                return new Intl.NumberFormat('vi-VN').format(value) + ' VND';
              }
            },
            grid: { color: "rgba(255,255,255,0.1)" }
          },
          x: {
            ticks: {
              color: "#fff",
              font: { size: 14, weight: "bold" }
            },
            grid: { color: "rgba(255,255,255,0.1)" }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: "#fff"
            }
          }
        }
      }
    });
</script>

{% endblock %}