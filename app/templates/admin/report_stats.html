{% extends 'admin/master.html' %}

{% block head %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .admin-stats-container {
            background-color: #f8f9fa !important;
            padding: 20px;
            border-radius: 10px;
        }

        .admin-stat-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .admin-stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #198754;
        }

        .admin-chart-container {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .admin-filter-form {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .table-container {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
        }
    </style>
{% endblock %}

{% block body %}
<div class="admin-stats-container">
    <h2 class="mb-4">üìä Th·ªëng k√™ s·ª± ki·ªán & doanh thu (Admin)</h2>

    <!-- B·ªô l·ªçc -->
    <div class="admin-filter-form">
        <form method="GET" class="d-flex justify-content-start align-items-center gap-3">
            <!-- Ch·ªçn nƒÉm -->
            <div>
                <label class="form-label">NƒÉm:</label>
                <select name="year" class="form-select">
                    <option value="">-- T·∫•t c·∫£ nƒÉm --</option>
                    {% for year in years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Ch·ªçn th√°ng -->
            <div>
                <label class="form-label">Th√°ng:</label>
                <select name="month" class="form-select" id="monthSelect">
                    <option value="">-- T·∫•t c·∫£ th√°ng --</option>
                    {% for i in range(1, 13) %}
                        <option value="{{ i }}" {% if i == selected_month %}selected{% endif %}>Th√°ng {{ i }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Ch·ªçn qu√Ω -->
            <div>
                <label class="form-label">Qu√Ω:</label>
                <select name="quarter" class="form-select" id="quarterSelect">
                    <option value="">-- T·∫•t c·∫£ qu√Ω --</option>
                    <option value="1" {% if selected_quarter == 1 %}selected{% endif %}>Qu√Ω 1</option>
                    <option value="2" {% if selected_quarter == 2 %}selected{% endif %}>Qu√Ω 2</option>
                    <option value="3" {% if selected_quarter == 3 %}selected{% endif %}>Qu√Ω 3</option>
                    <option value="4" {% if selected_quarter == 4 %}selected{% endif %}>Qu√Ω 4</option>
                </select>
            </div>

            <!-- N√∫t l·ªçc -->
            <div style="margin-left: 20px">
                <button type="submit" class="btn btn-success">L·ªçc</button>
                <a href="/admin/statsview/" class="btn btn-secondary">Reset</a>
            </div>
        </form>
    </div>

    <!-- Th·ªëng k√™ t·ªïng quan -->
    <div class="row">
        <div class="col-md-6">
            <div class="admin-stat-card text-center">
                <h5 class="text-muted">T·ªïng s·ªë s·ª± ki·ªán</h5>
                <div class="admin-stat-number">{{ total_events }}</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="admin-stat-card text-center">
                <h5 class="text-muted">T·ªïng doanh thu</h5>
                <div class="admin-stat-number">{{ "{:,.0f}".format(total_revenue) }} VND</div>
            </div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì -->
    <div class="row">
        <div class="col-md-6">
            <div class="admin-chart-container">
                <h6>Bi·ªÉu ƒë·ªì s·ªë l∆∞·ª£ng s·ª± ki·ªán</h6>
                <canvas id="eventsChart" width="400" height="200"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="admin-chart-container">
                <h6>Bi·ªÉu ƒë·ªì doanh thu</h6>
                <canvas id="revenueChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Chi ti·∫øt s·ª± ki·ªán -->
    {% if event_statistics %}
    <div class="table-container">
        <h5 class="mb-3">üìã Chi ti·∫øt s·ª± ki·ªán</h5>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>T√™n s·ª± ki·ªán</th>
                        <th>Ng√†y</th>
                        <th>Gi·ªù</th>
                        <th>V√© ƒë√£ b√°n</th>
                        <th>Doanh thu</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in event_statistics %}
                    <tr>
                        <td>{{ event.name }}</td>
                        <td>{{ event.date.strftime('%d/%m/%Y') }}</td>
                        <td>{{ event.time.strftime('%H:%M') }}</td>
                        <td>{{ event.tickets_sold }}</td>
                        <td>{{ "{:,.0f}".format(event.revenue) }} VND</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // X·ª≠ l√Ω t∆∞∆°ng t√°c gi·ªØa month v√† quarter select
    const monthSelect = document.getElementById('monthSelect');
    const quarterSelect = document.getElementById('quarterSelect');

    monthSelect.addEventListener('change', function() {
        if (this.value) {
            quarterSelect.value = '';
            quarterSelect.disabled = true;
        } else {
            quarterSelect.disabled = false;
        }
    });

    quarterSelect.addEventListener('change', function() {
        if (this.value) {
            monthSelect.value = '';
            monthSelect.disabled = true;
        } else {
            monthSelect.disabled = false;
        }
    });

    // Kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu
    if (monthSelect.value) {
        quarterSelect.disabled = true;
    }
    if (quarterSelect.value) {
        monthSelect.disabled = true;
    }

    // D·ªØ li·ªáu t·ª´ backend
    const eventsData = {{ monthly_events | safe }};
    const revenueData = {{ monthly_revenue | safe }};

    // X·ª≠ l√Ω labels
    let chartLabels, chartEventsData, chartRevenueData;

    {% if selected_quarter %}
        const quarterMonths = {
            1: ["Th√°ng 1", "Th√°ng 2", "Th√°ng 3"],
            2: ["Th√°ng 4", "Th√°ng 5", "Th√°ng 6"],
            3: ["Th√°ng 7", "Th√°ng 8", "Th√°ng 9"],
            4: ["Th√°ng 10", "Th√°ng 11", "Th√°ng 12"]
        };
        chartLabels = quarterMonths[{{ selected_quarter }}];
        chartEventsData = eventsData;
        chartRevenueData = revenueData;
    {% elif selected_month %}
        chartLabels = ["Th√°ng {{ selected_month }}"];
        chartEventsData = eventsData;
        chartRevenueData = revenueData;
    {% else %}
        chartLabels = ["T1", "T2", "T3", "T4", "T5", "T6", "T7", "T8", "T9", "T10", "T11", "T12"];
        chartEventsData = eventsData;
        chartRevenueData = revenueData;
    {% endif %}

    // Bi·ªÉu ƒë·ªì s·ª± ki·ªán
    new Chart(document.getElementById("eventsChart"), {
        type: "bar",
        data: {
            labels: chartLabels,
            datasets: [{
                label: "S·ªë s·ª± ki·ªán",
                data: chartEventsData,
                backgroundColor: "rgba(25,135,84,0.8)",
                borderColor: "rgba(25,135,84,1)",
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });

    // Bi·ªÉu ƒë·ªì doanh thu
    new Chart(document.getElementById("revenueChart"), {
        type: {% if selected_month %}"bar"{% else %}"line"{% endif %},
        data: {
            labels: chartLabels,
            datasets: [{
                label: "Doanh thu (VND)",
                data: chartRevenueData,
                backgroundColor: {% if selected_month or selected_quarter %}"rgba(25,135,84,0.8)"{% else %}"rgba(25,135,84,0.2)"{% endif %},
                borderColor: "rgba(25,135,84,1)",
                borderWidth: 2,
                {% if not selected_month and not selected_quarter %}fill: true{% endif %}
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return new Intl.NumberFormat('vi-VN').format(value) + ' VND';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });
</script>
{% endblock %}
